from pythonnet import load
load("coreclr")
import clr
clr.AddReference("dnlib")
from dnlib import DotNet
from dnlib.DotNet import *
from dnlib.DotNet.Emit import *


# -------- CONSTANTS -------- #
SAMPLE_PATH = "./Server.exe"
CLASS_NAME = "OK"
VARIABLE_NAME = "usbx"


# -------- MAIN -------- #
module = ModuleDefMD.Load(SAMPLE_PATH)

OK_constructor = None
for t in module.GetTypes():
    if t.Name == CLASS_NAME:
        for m in t.Methods:
            if m.Name in [".cctor", ".ctor"]:
                OK_constructor = m
                break

instructions = list(OK_constructor.Body.Instructions)
for i in range(len(instructions)):
    inst = instructions[i]
    if inst.OpCode.Name == "ldstr":
        value = inst.Operand
        next_inst = instructions[i + 1]
        if next_inst.OpCode == OpCodes.Stsfld and next_inst.Operand.Name.get_String() == VARIABLE_NAME:
            print(f"{CLASS_NAME}.{VARIABLE_NAME} = {value}")
            break
