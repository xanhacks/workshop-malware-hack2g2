#!/usr/bin/env python3
import os
import tempfile

import requests
import mwdblib
import pyzipper


# ----------- CONSTANTS -----------
MALWARE_FAMILY = "njrat"
API_URL = "https://mb-api.abuse.ch/api/v1/"
QUERY = {"query": "get_siginfo", "signature": MALWARE_FAMILY, "limit": 50}

MWDB_API_URL = "http://localhost:8888/api/"
MWDB_USERNAME, MWDB_PASSWORD = "admin", "TO_COMPLETE_WITH_YOUR_PASSWORD"

# ----------- CODE -----------
def get_sample_content(sample_sha256, sample_file_type):
    """Return the raw content of a sample."""
    sample_content = None
    resp = requests.post(API_BASE_URL, data={"query": "get_file", "sha256_hash": sample_sha256})

    if resp.ok:
        temp_file = tempfile.NamedTemporaryFile(delete=False)
        temp_file.write(resp.content)
        temp_file.close()

        with pyzipper.AESZipFile(temp_file.name) as zf:
            zf.setpassword(b"infected")
            sample_content = zf.read(sample_sha256 + "." + sample_file_type)

        os.remove(temp_file.name)

    return sample_content

# definition of the MWDB API object
mwdb = mwdblib.MWDB(api_url=MWDB_API_URL, username=MWDB_USERNAME, password=MWDB_PASSWORD)

# fetching samples from MalwareBazaar API
resp = requests.post(API_URL, data=QUERY)
samples = resp.json()["data"]

# looping over samples
print(f"Found {len(samples)} samples.")
for sample in samples:
    print(sample)

    # TODO: uncomment and complete the following lines to add samples to MWDB
    # file_sha256 = ...
    # file_name = ...
    # file_type = ...
    # file_content = get_sample_content(file_sha256, file_type)
    # mwdb.add_sample(name=file_name, content=file_content, tags=[MALWARE_FAMILY, "feed:malwarebazaar"], public=True)

